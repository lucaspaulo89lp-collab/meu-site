(function(){
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);

  function pad(n){ return String(n).padStart(2,"0"); }
  function fmtTime(sec){
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return `${pad(m)}:${pad(s)}`;
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // ---------- Wallet integration ----------
  function getCoins(){
    // Usa sua API global do wallet.js se existir
    if(window.PT && typeof window.PT.getCoins === "function") return window.PT.getCoins();
    // fallback
    const v = localStorage.getItem("pt_coins");
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function addCoins(amount){
    if(amount <= 0) return;
    if(window.PT && typeof window.PT.addCoins === "function") {
      window.PT.addCoins(amount);
      return;
    }
    // fallback
    const current = getCoins();
    localStorage.setItem("pt_coins", String(current + amount));
  }

  function setTheme(theme){
    // Se wallet.js tiver applyCosmetics, usa
    if(window.PT && typeof window.PT.applyCosmetics === "function"){
      // aplica sÃ³ tema (skin fica default)
      const settings = (window.PT.getSettings && window.PT.getSettings()) || {};
      settings.theme = theme;
      if(window.PT.setSettings) window.PT.setSettings(settings);
      window.PT.applyCosmetics();
    } else {
      // fallback simples via atributo
      document.body.setAttribute("data-skin", theme);
    }
  }

  function updateCoinsUI(){
    const el = $("coinVal");
    if(el) el.textContent = String(getCoins());
  }

  // ---------- Game config ----------
  const SYMBOLS = ["ðŸ¯","ðŸ€","ðŸ’Ž","ðŸ”¥","âš¡","ðŸŒ™","ðŸ§ ","ðŸŽ¯","ðŸª™","ðŸŽ®","â­","ðŸ§©","ðŸŸ©","ðŸŸ¦","ðŸŸ§","ðŸŸ¥","ðŸŸª","ðŸŸ¨"];
  const DIFF = {
    easy:  { cols:4, rows:3, label:"FÃ¡cil",  baseReward: 8 },
    normal:{ cols:4, rows:4, label:"Normal", baseReward: 12 },
    hard:  { cols:6, rows:4, label:"DifÃ­cil", baseReward: 18 }
  };

  let state = null;
  let timer = null;

  function resetState(){
    state = {
      started:false,
      locked:false,
      moves:0,
      pairs:0,
      totalPairs:0,
      time:0,
      first:null,
      second:null,
      diffKey:"normal",
      theme:"aurora"
    };
  }

  function stopTimer(){
    if(timer){ clearInterval(timer); timer = null; }
  }

  function startTimer(){
    stopTimer();
    timer = setInterval(() => {
      state.time++;
      $("timeVal").textContent = fmtTime(state.time);
      updateRewardPreview();
    }, 1000);
  }

  function updateHeader(){
    $("movesVal").textContent = String(state.moves);
    $("pairsVal").textContent = String(state.pairs);
    $("pairsTotal").textContent = String(state.totalPairs);
    $("diffVal").textContent = DIFF[state.diffKey].label;
    updateCoinsUI();
    updateRewardPreview();
  }

  function calcReward(){
    // recompensa fictÃ­cia: base + bÃ´nus por desempenho
    const base = DIFF[state.diffKey].baseReward;

    // movimentos "ideais" = total cards * 1.1 aprox
    const idealMoves = Math.ceil(state.totalPairs * 2 * 1.1);
    const moveBonus = Math.max(0, Math.round((idealMoves - state.moves) * 0.8));

    // bÃ´nus de tempo: quanto mais rÃ¡pido, maior
    // hard tolera mais tempo
    const timeTarget = state.diffKey === "hard" ? 90 : state.diffKey === "normal" ? 70 : 55;
    const timeBonus = Math.max(0, Math.round((timeTarget - state.time) * 0.2));

    // limita
    const total = Math.max(4, Math.min(60, base + moveBonus + timeBonus));
    return total;
  }

  function updateRewardPreview(){
    const el = $("rewardPreview");
    if(!el) return;
    if(!state.started){
      el.textContent = `+${DIFF[state.diffKey].baseReward} ðŸª™`;
      return;
    }
    el.textContent = `+${calcReward()} ðŸª™`;
  }

  function buildDeck(){
    const {cols, rows} = DIFF[state.diffKey];
    const totalCards = cols * rows;
    const pairs = Math.floor(totalCards / 2);
    state.totalPairs = pairs;

    const chosen = SYMBOLS.slice(0, pairs);
    const deck = shuffle([...chosen, ...chosen]);

    const board = $("board");
    board.innerHTML = "";
    board.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

    deck.forEach((sym, idx) => {
      const card = document.createElement("button");
      card.className = "card";
      card.type = "button";
      card.setAttribute("aria-label", "Carta");
      card.dataset.symbol = sym;
      card.dataset.index = String(idx);

      const back = document.createElement("div");
      back.className = "cardInner cardBack";
      back.textContent = "ðŸ¾";

      const front = document.createElement("div");
      front.className = "cardInner cardFront";
      front.textContent = sym;

      card.appendChild(back);
      card.appendChild(front);

      card.addEventListener("click", () => onCardClick(card));

      board.appendChild(card);
    });

    updateHeader();
  }

  function flip(card){
    card.classList.add("flipped");
  }
  function unflip(card){
    card.classList.remove("flipped");
  }
  function lock(card){
    card.classList.add("matched");
    card.disabled = true;
  }

  function onCardClick(card){
    if(!state.started) return;
    if(state.locked) return;
    if(card.classList.contains("matched")) return;
    if(card === state.first) return;

    flip(card);

    if(!state.first){
      state.first = card;
      return;
    }

    state.second = card;
    state.moves++;
    $("movesVal").textContent = String(state.moves);

    const a = state.first.dataset.symbol;
    const b = state.second.dataset.symbol;

    if(a === b){
      lock(state.first);
      lock(state.second);
      state.pairs++;
      $("pairsVal").textContent = String(state.pairs);

      state.first = null;
      state.second = null;

      if(state.pairs >= state.totalPairs){
        onWin();
      }
      return;
    }

    // errou
    state.locked = true;
    setTimeout(() => {
      unflip(state.first);
      unflip(state.second);
      state.first = null;
      state.second = null;
      state.locked = false;
    }, 520);
  }

  function onWin(){
    stopTimer();

    const reward = calcReward();
    addCoins(reward);
    updateCoinsUI();

    const summary = `Tempo: ${fmtTime(state.time)} â€¢ Movimentos: ${state.moves} â€¢ Dificuldade: ${DIFF[state.diffKey].label}`;
    $("winSummary").textContent = summary;
    $("winReward").textContent = `+${reward} ðŸª™ (fictÃ­cio)`;

    const modal = $("winModal");
    modal.classList.add("show");
    modal.setAttribute("aria-hidden","false");
  }

  function closeWin(){
    const modal = $("winModal");
    modal.classList.remove("show");
    modal.setAttribute("aria-hidden","true");
  }

  function startGame(){
    closeWin();
    state.started = true;
    state.moves = 0;
    state.pairs = 0;
    state.time = 0;
    state.first = null;
    state.second = null;
    state.locked = false;

    $("timeVal").textContent = "00:00";
    $("movesVal").textContent = "0";
    $("pairsVal").textContent = "0";

    buildDeck();
    startTimer();
    updateHeader();
  }

  // ---------- UI Events ----------
  function bindUI(){
    $("difficulty").addEventListener("change", (e) => {
      state.diffKey = e.target.value;
      updateHeader();
      // se jÃ¡ comeÃ§ou, rebuild com reset
      if(state.started) startGame();
      else buildDeck();
    });

    $("theme").addEventListener("change", (e) => {
      state.theme = e.target.value;
      setTheme(state.theme);
    });

    $("btnStart").addEventListener("click", startGame);
    $("btnReset").addEventListener("click", () => {
      state.started = false;
      stopTimer();
      $("timeVal").textContent = "00:00";
      $("movesVal").textContent = "0";
      $("pairsVal").textContent = "0";
      closeWin();
      buildDeck();
      updateHeader();
    });

    $("btnPlayAgain").addEventListener("click", startGame);
  }

  // ---------- Boot ----------
  window.addEventListener("DOMContentLoaded", () => {
    resetState();
    bindUI();

    // aplica tema inicial (pega do wallet se existir)
    try{
      if(window.PT && typeof window.PT.getSettings === "function"){
        const s = window.PT.getSettings();
        if(s && s.theme) state.theme = s.theme;
      }
    }catch(e){}
    $("theme").value = state.theme;
    setTheme(state.theme);

    buildDeck();
    updateCoinsUI();

    // atualiza saldo sempre
    setInterval(updateCoinsUI, 900);
  });
})();
